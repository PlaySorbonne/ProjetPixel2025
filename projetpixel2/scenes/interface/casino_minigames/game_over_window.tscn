[gd_scene load_steps=11 format=3 uid="uid://cjbto8ostw162"]

[ext_resource type="PackedScene" uid="uid://chp3bd6blfvcj" path="res://scenes/interface/casino_minigames/casino_window.tscn" id="1_253de"]
[ext_resource type="Script" uid="uid://dckgq8vd5khcv" path="res://scripts/game_over_window.gd" id="2_j0oe4"]
[ext_resource type="Texture2D" uid="uid://flq7ab6bhtyy" path="res://resources/images/casino/rug_seamless_texture_contrast_dark.png" id="3_ait10"]
[ext_resource type="FontFile" uid="uid://bow4cpnaeoi8k" path="res://resources/fonts/title1_xirod.otf" id="4_j0oe4"]
[ext_resource type="FontFile" uid="uid://bkxfmoq2htvql" path="res://resources/fonts/text_hard_toxigenesis bd.otf" id="5_ait10"]
[ext_resource type="PackedScene" uid="uid://cvsdd7hpynwts" path="res://scenes/interface/menus/objects/button_sci_fi.tscn" id="6_12pqm"]

[sub_resource type="Shader" id="Shader_12pqm"]
resource_local_to_scene = true
code = "shader_type canvas_item;

/* ================= SCROLL SETTINGS ================= */

uniform float scroll_speed : hint_range(0, 2) = 0.08;
uniform float angle_degrees : hint_range(0, 360) = 45.0;
uniform float repeat_x : hint_range(0.1, 20) = 1.2;
uniform float repeat_y : hint_range(0.1, 20) = 1.2;
uniform sampler2D texture_to_scroll;

/* ================= GLITCH SETTINGS ================= */

uniform float glitch_chance : hint_range(0.0, 1.0) = 0.02;
uniform float glitch_speed = 7.0;
uniform float slice_density = 14.0;
uniform float slice_strength = 0.38;
uniform float shake_strength = 0.02;
uniform float chroma_offset = 0.016;
uniform float noise_strength = 0.2;
uniform float color_flash_strength = 0.4;
uniform float scanline_strength = 0.18;
uniform float local_warp_strength = 0.14;
uniform float flip_chance : hint_range(0.0,1.0) = 0.05;

/* ================= RANDOM ================= */

float rand(float x) { 
	return fract(sin(x * 143758.5453) * 43758.5453); 
}

float rand2(vec2 p) { 
	return fract(sin(dot(p, vec2(127.1,311.7))) * 43758.5453); 
}

/* ================= FRAGMENT ================= */

void fragment() {

	/* ---------- TEXTURE SCROLL ---------- */

	float angle_rad = radians(angle_degrees);
	vec2 direction = vec2(cos(angle_rad), sin(angle_rad));

	vec2 uv = UV - (TIME * scroll_speed * direction);

	float row = fract(floor(uv.y * repeat_y) * 0.5);

	vec2 scaled_uv = vec2(
		fract(uv.x * repeat_x),
		fract(uv.y * repeat_y)
	);

	vec2 texel_size = vec2(1.0) / vec2(textureSize(texture_to_scroll, 0));
	vec2 snapped_uv = round(scaled_uv / texel_size) * texel_size;

	/* ---------- GLITCH TRIGGER ---------- */

	float glitch = step(1.0 - glitch_chance, rand(floor(TIME * glitch_speed)));

	/* ---------- SLICE EFFECT ---------- */

	float slice_id = floor(snapped_uv.y * slice_density + rand(floor(TIME)));
	float slice_rand = rand(slice_id + floor(TIME * glitch_speed));
	float slice_mask = step(0.5, slice_rand) * glitch;

	if (rand(slice_id * TIME) < flip_chance) {
		snapped_uv.x = 1.0 - snapped_uv.x;
	}

	snapped_uv.x += (slice_rand - 0.5) * slice_strength * slice_mask;

	/* ---------- MICRO JITTER ---------- */

	float jitter = step(0.85, rand(TIME * 12.0)) * glitch;
	snapped_uv.x += (rand(TIME * 3.0) - 0.5) * 0.08 * jitter;

	/* ---------- LOCAL WARP ---------- */

	float warp_zone = step(0.65, rand2(vec2(slice_id, TIME)));
	snapped_uv +=
		(vec2(rand2(snapped_uv + TIME), rand2(snapped_uv - TIME)) - 0.5)
		* local_warp_strength * warp_zone * glitch;

	/* ---------- GLOBAL SHAKE ---------- */

	snapped_uv += vec2(
		rand(TIME * 1.3) - 0.5,
		rand(TIME * 1.7) - 0.5
	) * shake_strength * glitch;

	/* ---------- BASE SAMPLE ---------- */

	vec4 base = texture(texture_to_scroll, snapped_uv);

	/* ---------- CHROMATIC SPLIT ---------- */

	float r = texture(texture_to_scroll, snapped_uv + vec2(chroma_offset * glitch, 0.0)).r;
	float b = texture(texture_to_scroll, snapped_uv - vec2(chroma_offset * glitch, 0.0)).b;
	vec3 color = vec3(r, base.g, b);

	/* ---------- DIGITAL NOISE ---------- */

	color += (rand2(snapped_uv * TIME * 1.5) - 0.5) * noise_strength * glitch;

	/* ---------- SCANLINE DROP ---------- */

	float scan = step(0.9, rand(snapped_uv.y * 100.0 + TIME * 10.0));
	color *= 1.0 - scan * scanline_strength * glitch;

	/* ---------- COLOR FLASH ---------- */

	vec3 flash_color = vec3(
		step(0.5, rand(TIME + 0.1)),
		step(0.5, rand(TIME + 3.1)),
		step(0.5, rand(TIME + 6.1))
	);

	color = mix(
		color,
		flash_color,
		rand(TIME * 4.0) * color_flash_strength * glitch
	);
	
	vec2 p = FRAGCOORD.xy - SCREEN_UV.xy / SCREEN_PIXEL_SIZE;

	COLOR = vec4(color, base.a);
}
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_kkjw3"]
resource_local_to_scene = true
shader = SubResource("Shader_12pqm")
shader_parameter/scroll_speed = 0.08
shader_parameter/angle_degrees = 45.0
shader_parameter/repeat_x = 1.1
shader_parameter/repeat_y = 1.1
shader_parameter/texture_to_scroll = ExtResource("3_ait10")
shader_parameter/glitch_chance = 0.02
shader_parameter/glitch_speed = 7.0
shader_parameter/slice_density = 14.0
shader_parameter/slice_strength = 0.38
shader_parameter/shake_strength = 0.02
shader_parameter/chroma_offset = 0.016
shader_parameter/noise_strength = 0.2
shader_parameter/color_flash_strength = 0.4
shader_parameter/scanline_strength = 0.18
shader_parameter/local_warp_strength = 0.14
shader_parameter/flip_chance = 0.05

[sub_resource type="LabelSettings" id="LabelSettings_ait10"]
font = ExtResource("4_j0oe4")
font_size = 36
outline_size = 24
outline_color = Color(0.592157, 0.00784314, 0.0901961, 1)

[sub_resource type="LabelSettings" id="LabelSettings_12pqm"]
font = ExtResource("5_ait10")
font_size = 18

[node name="GameOverWindow" instance=ExtResource("1_253de")]
anchor_left = 0.317187
anchor_top = 0.316667
anchor_right = 0.683333
anchor_bottom = 0.682407
grow_horizontal = 2
grow_vertical = 2
script = ExtResource("2_j0oe4")
can_close_window = false

[node name="Background" parent="Panel" index="0"]
material = SubResource("ShaderMaterial_kkjw3")

[node name="Label" type="Label" parent="Contents" index="1"]
layout_mode = 1
anchors_preset = 10
anchor_right = 1.0
offset_bottom = 90.0
grow_horizontal = 2
text = "Game Over"
label_settings = SubResource("LabelSettings_ait10")
horizontal_alignment = 1
vertical_alignment = 2

[node name="Label2" type="Label" parent="Contents" index="2"]
layout_mode = 1
anchors_preset = 10
anchor_right = 1.0
offset_left = 12.0
offset_top = 109.0
offset_right = -21.0002
offset_bottom = 236.0
grow_horizontal = 2
text = "Ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed ship destroyed...."
label_settings = SubResource("LabelSettings_12pqm")
autowrap_mode = 2

[node name="ButtonQuit" parent="Contents" index="3" instance=ExtResource("6_12pqm")]
layout_mode = 1
anchor_left = 0.370839
anchor_top = 0.785318
anchor_right = 0.60128
anchor_bottom = 0.939748
pivot_offset = Vector2(81.0001, 30.4999)
button_text = "Continue"

[connection signal="pressed" from="Contents/ButtonQuit" to="." method="_on_button_quit_pressed"]
